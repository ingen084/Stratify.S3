# Stratify.S3 開発ガイド

このドキュメントは、Claude AIアシスタントがStratify.S3プロジェクトを効率的に理解し、開発をサポートするための情報を提供します。

## プロジェクト概要

Stratify.S3は、複数のファイルシステムストレージをS3互換APIで統合するレイヤードストレージプロキシです。ASP.NET Core Minimal APIで実装されており、高可用性とフェイルオーバー機能を提供します。

## アーキテクチャ

### ストレージ階層
- **プライマリストレージ**: 最高優先度（Priority=1）、正常時にすべてのファイルが保存される
- **セカンダリストレージ**: 低優先度（Priority=2,3...）、プライマリ障害時のフェイルオーバー先
- **動作原理**: 
  - 正常時: プライマリのみに書き込み
  - プライマリ障害時: セカンダリに書き込み
  - プライマリ復旧時: セカンダリからプライマリにファイルを移動

## プロジェクト構造

```
Stratify.S3/
├── Program.cs              # メインアプリケーション、APIエンドポイント定義
├── Models/
│   └── BackendConfiguration.cs  # 設定モデル定義
├── Services/
│   └── BackendManager.cs   # ストレージバックエンド管理ロジック
├── Helpers/
│   └── S3XmlHelper.cs      # S3互換XMLレスポンス生成
├── appsettings.json        # アプリケーション設定
└── Stratify.S3.csproj      # プロジェクトファイル
```

## 主要コンポーネント

### BackendManager
- ストレージバックエンドの健全性チェック
- ファイルの検索、フェイルオーバー、復旧機能
- 優先度ベースのストレージ選択
- プライマリ復旧時のファイル移動処理

### S3XmlHelper
- S3互換のXMLレスポンス生成
- エラーレスポンスのフォーマット

### RecoveryHostedService
- バックグラウンドでの自動復旧処理
- セカンダリからプライマリへのファイル移動
- 冗長ファイルの自動削除

## 開発時の注意事項

### コーディング規約
- C# 12の最新機能を活用（プライマリコンストラクタ、パターンマッチングなど）
- 非同期処理を優先（async/await）
- 適切なログ出力（ILogger使用）

### パフォーマンス考慮事項
- 大きなファイルはストリーミング処理
- 不要なメモリアロケーションを避ける
- バックグラウンドタスクは適切にスロットリング

### エラーハンドリング
- S3互換のエラーコードを返す
- 部分的な失敗でもサービスを継続
- 詳細なログでデバッグを支援

## テストとデバッグ

### ローカル実行
```bash
dotnet run
```

### テスト用コマンド
```bash
# ビルドとテスト
dotnet build
dotnet test

# コードフォーマット
dotnet format

# 静的解析
dotnet analyzers
```

### デバッグ時の確認ポイント
1. ストレージパスのアクセス権限
2. ヘルスチェックログ
3. 復旧タスクの実行状況

## 拡張ポイント

### 新しいS3操作の追加
1. `Program.cs`に新しいエンドポイントを追加
2. `S3XmlHelper.cs`に必要なXMLフォーマッタを追加
3. 適切なエラーハンドリングを実装

### ストレージバックエンドの拡張
1. `BackendConfiguration.cs`に新しい設定項目を追加
2. `BackendManager.cs`にバックエンド固有のロジックを実装

### パフォーマンス最適化
- 並列処理の活用（Parallel.ForEachAsync）
- キャッシング戦略の実装
- 接続プーリングの最適化

## よくある問題と解決方法

### "No available backends"エラー
- すべてのバックエンドパスが存在し、書き込み可能か確認
- ヘルスチェックファイルの作成権限を確認

### メモリ使用量が高い
- `ChunkSize`を小さくする
- 大きなファイルのアップロード時はストリーミング処理を確認

### 復旧が完了しない
- `RecoveryTimeout`の値を増やす
- ネットワーク帯域幅とストレージI/O性能を確認
- プライマリストレージのアクセス権限を確認

### プライマリストレージでの削除が失敗する
- プライマリストレージが使用可能な場合、削除操作はプライマリで成功する必要がある
- プライマリストレージのアクセス権限とディスク容量を確認

## 今後の改善案

1. **S3 Multipart Upload対応**: 大きなファイルの効率的なアップロード
2. **メトリクス収集**: Prometheus/OpenTelemetry統合
3. **認証・認可**: S3署名検証の実装
4. **圧縮転送**: gzip/brotli対応
5. **イベント通知**: ファイル変更時のWebhook/メッセージング

## リリース手順

```bash
# リリースビルド
dotnet publish -c Release -o ./publish

# Dockerイメージ作成（Dockerfileが必要）
docker build -t stratify-s3:latest .

# 実行
dotnet ./publish/Stratify.S3.dll
```